<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Voice Recognition</title>
      <link rel="icon" href="static/images/microphone.png" type="image/x-icon" /> 
      <meta name="description" content="Voice recognition web app">
      <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
      <link rel="stylesheet" type="text/css" href="static/css/style.css">
      <link rel="stylesheet" href="static/css/responsive.css">
   
      <style>
         #recording-timer h1 {
           font-size: 3rem; /* Increase the size of h1 */
         }
      </style>
   
   </head>
   <body>
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.bundle.min.js"></script>

      <div class="header_section">
         <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="logo" href="/"><img src="static/images/logo.svg"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
            </button>
         </nav>
      </div>

      <div class="cooming_section layout_padding">
         <div class="container">
            <div class="row">
               <div class="col-md-6">
                  <div class="image_17">
                     <img src="static/images/img-17.png">
                  </div>
               </div>
               <div class="col-md-6">
                  <div class="play_icon">
                    <button id="recognize-record-btn" data-toggle="tooltip" data-placement="top" title="Click here to start voice recording">
                        <img src="static/images/microphone.png" class="mic-icon" alt="Mic Icon">
                     </button>
                    
                  </div>
                  <div id="recording-timer"><h1>0:00</h1></div>
                  <!-- <button onclick="startListening()">Speak Now</button> -->
                  <h1 id="statusText" class="Cooming_soon_taital">
                     <span class="recording-text">Recognize</span><span id="recordingDots" class="dot-animation"><span>.</span><span>.</span><span>.</span></span>
                  </h1>
                  <p class="long_text_1">"My voice is my password"</p>


                  <div id="recognize-status" style="display: none;"></div>
                  <div id="message"></div>
                  
               </div>
            </div>
         </div>
      </div>
      <div id="recognitionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="recognitionModalLabel" aria-hidden="true">
         <div class="modal-dialog" role="document">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title" id="recognitionModalLabel">Voice Recognition Result</h5>
                     <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="window.location.reload();">
                         <span aria-hidden="true">&times;</span>
                     </button>
                 </div>
                 <div class="modal-body">
                     <p id="modalMessage"></p>
                     <p id="Transcription"></p>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="window.location.reload();">OK</button>
                 </div>
             </div>
         </div>
     </div>
      <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioContext;
        let audioStream;
        let timerInterval;
        let elapsedTime = 0;

         const recognizeButton = document.getElementById('recognize-record-btn');
         const recognizeStatusDiv = document.getElementById('recognize-status');
         const messageDiv = document.getElementById('message');
         const statusText = document.getElementById('statusText');
         const passwordHint = document.querySelector('.long_text_1');

         function resetUI() {
            statusText.innerHTML = '<span class="recording-text">Recognize</span><span id="recordingDots" class="dot-animation"><span>.</span><span>.</span><span>.</span></span>';
            if (passwordHint) {
               passwordHint.style.display = 'block';
            }
            recognizeStatusDiv.textContent = '';
            messageDiv.textContent = '';
         }
      
         function startRecording() {
         navigator.mediaDevices.getUserMedia({ audio: true })
         .then(stream => {
            audioStream = stream;
            audioContext = new AudioContext({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(stream);
            const recorder = audioContext.createScriptProcessor(4096, 1, 1);
            source.connect(recorder);
            recorder.connect(audioContext.destination);
            recorder.onaudioprocess = function(event) {
               const inputData = event.inputBuffer.getChannelData(0);
               audioChunks.push(new Float32Array(inputData));
            };
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.onstop = () => {
               const blob = exportWAV(audioChunks, 16000);
               audioChunks = [];
               recognizeVoice(blob);
               stopMicrophoneAccess();
            };
         mediaRecorder.start();
         statusText.querySelector('.recording-text').textContent = "Recording";  // Show "Recording" during the process
         recognizeButton.querySelector(".mic-icon").classList.add("recording");
         elapsedTime = 0;
         startTimer();  // Function to start timer
         setTimeout(() => {
            mediaRecorder.stop();
            stopTimer(); // Stop the timer
            statusText.querySelector('.recording-text').textContent = "Processing"; // Update status
            recognizeButton.querySelector(".mic-icon").classList.remove("recording");
         }, 5000); // 5000 milliseconds = 5 seconds
      })
      .catch(error => {
         console.error("Error accessing the microphone: ", error);
      });
}

         function startTimer() {
            timerInterval = setInterval(() => {
               elapsedTime++;
               updateRecordingTime(elapsedTime);
            }, 1000); // Update every second (1000ms)
         }

         function stopTimer() {
            clearInterval(timerInterval);
         }

         function updateRecordingTime(timeInSeconds) {
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = timeInSeconds % 60;
            const formattedTime = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            document.getElementById('recording-timer').querySelector('h1').textContent = formattedTime;  // Display timer in the UI
         }

         recognizeButton.addEventListener('click', () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
               resetUI(); 
               startRecording();
            } else if (mediaRecorder.state === "recording") {
               mediaRecorder.stop();
               stopTimer(); 
            }
         });

         function recognizeVoice(blob) {
         const formData = new FormData();
         formData.append('audio', blob, 'test.wav');

         recognizeStatusDiv.textContent = "Processing recognition...";
         const audioContext = new (window.AudioContext || window.webkitAudioContext)();

         blob.arrayBuffer()
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                  console.log("WAV file duration: ", audioBuffer.duration, "seconds");
                  return fetch('/recognize', {
                     method: 'POST',
                     body: formData
                  });
            })
            .then(response => response.json())
            .then(data => {
                  console.log("Recognition result: ", data);   
                  let message = data.msg;
                  let transcription=data.transcription;
                  console.log("Transcription: ", transcription);  
                  if (message === "Hey New User, Welcome to Stella Voice Assistant !!") {
                     message += `<br><a href="/register" id="register-link" class="register-link">Click here to register</a>`;
                  }
                  const modalMessageElem = document.getElementById('modalMessage');
                  const transcriptionTextElem = document.getElementById('transcriptionText');

                  if (modalMessageElem) {
                     modalMessageElem.innerHTML = message;
                  }

                  if (transcriptionTextElem) {
                     transcriptionTextElem.innerHTML = transcription;
                  }
                  if (passwordHint) {
                     passwordHint.style.display = 'none';
                  }

                  recognizeButton.querySelector(".mic-icon").classList.remove("recording");
                  recognizeStatusDiv.textContent = "";  // Clear processing message
                  $('#recognitionModal').modal('show');
                  statusText.querySelector('.recording-text').textContent = "Recognize"; 
            })
            .catch(error => {
                  messageDiv.textContent = "Error: " + error.message;
                  recognizeStatusDiv.textContent = "";
                  statusText.querySelector('.recording-text').textContent = "Recognize";
            });
         }

         function exportWAV(audioData, sampleRate) {
            const mergedBuffers = mergeBuffers(audioData, sampleRate * 5);
            const downsampledBuffer = downsampleBuffer(mergedBuffers, sampleRate);
            const wavBuffer = encodeWAV(downsampledBuffer, sampleRate);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }

         function mergeBuffers(audioData, length) {
            const result = new Float32Array(length);
            let offset = 0;
            for (let i = 0; i < audioData.length; i++) {
                result.set(audioData[i], offset);
                offset += audioData[i].length;
            }
            return result;
        }

         function downsampleBuffer(buffer, sampleRate) {
               if (sampleRate === 16000) return buffer;
               const ratio = audioContext.sampleRate / sampleRate;
               const newLength = Math.round(buffer.length / ratio);
               const result = new Float32Array(newLength);
               for (let i = 0; i < newLength; i++) {
                  result[i] = buffer[Math.round(i * ratio)];
               }
               return result;
         }

         function encodeWAV(samples, sampleRate) {
               const buffer = new ArrayBuffer(44 + samples.length * 2);
               const view = new DataView(buffer);

               writeString(view, 0, 'RIFF');
               view.setUint32(4, 36 + samples.length * 2, true);
               writeString(view, 8, 'WAVE');
               writeString(view, 12, 'fmt ');
               view.setUint32(16, 16, true);
               view.setUint16(20, 1, true);
               view.setUint16(22, 1, true);
               view.setUint32(24, sampleRate, true);
               view.setUint32(28, sampleRate * 2, true);
               view.setUint16(32, 2, true);
               view.setUint16(34, 16, true);
               writeString(view, 36, 'data');
               view.setUint32(40, samples.length * 2, true);

               let offset = 44;
               for (let i = 0; i < samples.length; i++, offset += 2) {
                  const sample = Math.max(-1, Math.min(1, samples[i]));
                  view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
               }

               return view;
         }

         function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

      </script>
   </body>
</html>


