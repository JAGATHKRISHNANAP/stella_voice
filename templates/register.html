<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice Registration</title>
    <link rel="icon" href="static/images/microphone.png" type="image/x-icon" /> 
    <meta name="description" content="Voice recognition web app">
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="static/css/style.css">
    <link rel="stylesheet" href="static/css/responsive.css">
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <div class="header_section">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="logo" href="/"><img src="static/images/logo.svg"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </nav>
    </div>

    <div class="cooming_section layout_padding">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="image_17">
                        <img src="static/images/img-17.png">
                    </div>
                </div>
                <div class="col-md-6">
                    <form id="registration-form">
                        <label for="name">Enter your name:</label><br>
                        <input type="text" id="name" name="name" required><br><br>
                        <div id="recording-timer"><h1>0:00</h1></div>

                        <div class="play_icon">
                            <button id="register-record-btn" type="button" data-toggle="tooltip" data-placement="top" title="Click here to start voice recording" disabled>
                                <img src="static/images/microphone.png" class="mic-icon" alt="Mic Icon">
                            </button>
                        </div>
                    </form>
                    <h1 id="statusText" class="Cooming_soon_taital">
                        <span class="recording-text">Recognize</span><span id="recordingDots" class="dot-animation"><span>.</span><span>.</span><span>.</span></span>
                    </h1>
                    <p class="long_text_1">"My voice is my password"</p>

                    <div id="register-status" style="display: none;"></div>
                    <div id="message"></div>
                    <div id="snackbar"></div>
                    <div id="successModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="successModalLabel">Registration Successful</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p id="modalMessage">Your registration was successful.</p>
                                    <p id="Transcription"></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioContext;
        let audioStream;

        let elapsedTime = 0;
        let timerInterval;

        const registerButton = document.getElementById('register-record-btn');
        const statusDiv = document.getElementById('register-status');
        const messageDiv = document.getElementById('message');
        const nameInput = document.getElementById('name');
        const micIcon = document.querySelector('.mic-icon');
        const passwordHint = document.querySelector('.long_text_1');
        // Disable button by default
        registerButton.disabled = true;
        function resetUI() {
    // Reset the status text to its initial "Recognize..." state
        statusText.innerHTML = '<span class="recording-text">Recognize</span><span id="recordingDots" class="dot-animation"><span>.</span><span>.</span><span>.</span></span>';

        // Show the "My voice is my password" text
        if (passwordHint) {
            passwordHint.style.display = 'block';
        }

        // Clear any recognition status or error message
        recognizeStatusDiv.textContent = '';
        messageDiv.textContent = '';
    }
        // Enable button only when name input has a value
        nameInput.addEventListener('input', function () {
            registerButton.disabled = !nameInput.value.trim();
        });

        // Manually validate the name input before starting recording
        registerButton.addEventListener('click', (event) => {
            event.preventDefault();
            
            if (!nameInput.value.trim()) {
                alert("Please enter your name.");
                return;
            }

            // Proceed with recording
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                stopTimer();
                registerButton.classList.remove("recording");
            } else {
                startRecording();
                registerButton.classList.add("recording");
            }
        });

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioStream = stream;
                    audioContext = new AudioContext({ sampleRate: 16000 });
                    const source = audioContext.createMediaStreamSource(stream);
                    const recorder = audioContext.createScriptProcessor(4096, 1, 1);

                    source.connect(recorder);
                    recorder.connect(audioContext.destination);

                    recorder.onaudioprocess = function (event) {
                        const inputData = event.inputBuffer.getChannelData(0);
                        audioChunks.push(new Float32Array(inputData));
                    };

                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.onstop = () => {
                        stopTimer();
                        const blob = exportWAV(audioChunks, 16000);
                        audioChunks = [];
                        registerVoice(blob);
                        stopMicrophoneAccess();
                    };

                    mediaRecorder.start();
                    statusText.querySelector('.recording-text').textContent = "Recording";
                    registerButton.querySelector(".mic-icon").classList.add("recording");
                    elapsedTime = 0;
                    startTimer();
                    setTimeout(() => {
                        mediaRecorder.stop();
                        stopTimer();
                        statusText.querySelector('.recording-text').textContent = "Recording stopped";
                        registerButton.querySelector(".mic-icon").classList.remove("recording");
                        // location.reload();
                    }, 5000);
                })
                .catch(error => {
                    console.error("Error accessing the microphone: ", error);
                });
        }

        function stopMicrophoneAccess() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
        }

        function updateRecordingTime(timeInSeconds) {
   const minutes = Math.floor(timeInSeconds / 60);
   const seconds = timeInSeconds % 60;
   const formattedTime = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
   document.getElementById('recording-timer').querySelector('h1').textContent = formattedTime;  // Display timer in the UI
}

        function startTimer() {
   timerInterval = setInterval(() => {
      elapsedTime++;
      updateRecordingTime(elapsedTime);
   }, 1000); // Update every second (1000ms)
}

        function stopTimer() {
        clearInterval(timerInterval);
        }

        function registerVoice(blob) {
    const name = document.getElementById('name').value;
    const formData = new FormData();
    formData.append('name', name);
    formData.append('audio', blob, 'train.wav');

    statusDiv.textContent = "Processing registration...";

    fetch('/register', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Update the modal message with the response
        const modalMessage = document.getElementById('modalMessage');
        modalMessage.textContent = data.msg;
        const Transcription=document.getElementById('Transcription')
        Transcription.textContent = data.transcription;
        $('#successModal').modal('show');
        $('#successModal').on('hidden.bs.modal', function () {
            location.reload();
        });
    })
    .catch(error => {
        messageDiv.textContent = "Error: " + error.message;
        statusDiv.textContent = "";
    });
}

        window.onload = function() {
            // Show the snackbar message
            showSnackbar();
        };

        function showSnackbar() {
            const snackbar = document.getElementById("snackbar");

            // Check if there's a message stored in localStorage
            const storedMessage = localStorage.getItem('snackbarMessage');
            if (storedMessage) {
                snackbar.textContent = storedMessage;
                snackbar.className = "show"; // Display the snackbar

                // Remove the message from localStorage after displaying
                localStorage.removeItem('snackbarMessage');

                // Hide the snackbar after 3 seconds
                setTimeout(function () {
                    snackbar.className = snackbar.className.replace("show", "");
                }, 3000); // 3 seconds display time
            }
        }

        function exportWAV(audioData, sampleRate) {
            const mergedBuffers = mergeBuffers(audioData, sampleRate * 5);
            const downsampledBuffer = downsampleBuffer(mergedBuffers, sampleRate);
            const wavBuffer = encodeWAV(downsampledBuffer, sampleRate);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }

        function mergeBuffers(audioData, length) {
            const result = new Float32Array(length);
            let offset = 0;
            for (let i = 0; i < audioData.length; i++) {
                result.set(audioData[i], offset);
                offset += audioData[i].length;
            }
            return result;
        }

        function downsampleBuffer(buffer, sampleRate) {
            if (sampleRate === 16000) {
                return buffer;
            }
            const ratio = sampleRate / 16000;
            const newLength = Math.round(buffer.length / ratio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
                let accum = 0, count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            const format = 1;
            const channels = 1;
            const bitsPerSample = 16;

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, channels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * channels * bitsPerSample / 8, true);
            view.setUint16(32, channels * bitsPerSample / 8, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                const s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }

            return buffer;
        }
    </script>
</body>

</html>
